<!DOCTYPE html>
<html>

<head>
    <style type="text/css">
        .profit {
            color: green
        }

        .loss {
            color: red
        }

        table,
        td,
        th {
            border: 1px solid black;
        }

        .loading table {
            visibility: hidden;
        }

        .loading title {
            visibility: visible;
        }

        :not(.loading) #progress {
            visibility: collapse;
            display: none;
        }

        .loading #progress {
            visibility: visible;
            display: inherit;
        }

        form {
            padding: 10px;
        }

        th {
            background-color: cornflowerblue;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }
    </style>
    <script async type="module">
        const formatPrice = function (price) {
            return price.toFixed(10);
        }

        const formatTotal = function (total) {
            return total.toFixed(2);
        }

        const processAddress = async (address) => {
            let result = await fetch('https://api.thegraph.com/subgraphs/name/uniswap/uniswap-v2',
                {
                    method: 'POST',
                    body: JSON.stringify({
                        query: `
                        {
                            bundle(id: 1) {
                                ethPrice
                            }

                            swaps(where: {
                                to: "${address}"
                            })
                            {
                                id
                                pair {
                                    token0 {
                                        symbol
                                        derivedETH
                                    }
                                    token1 {
                                        symbol
                                        derivedETH
                                    }
                                }
                                amount0In
                                amount0Out
                                amount1In
                                amount1Out
                                amountUSD
                                timestamp
                            }
                        }
                        `
                    })
                });

            const collect = function (items, out, ts, token, usd, ethPrice) {
                const outFloat = parseFloat(out);

                if (outFloat) {
                    const currentPrice = token.derivedETH * ethPrice;

                    const buy = {
                        price: usd / out,
                        total: parseFloat(usd),
                    };

                    const current = {
                        price: currentPrice,
                        total: currentPrice * out
                    };

                    items.push({
                        date: ts,
                        symbol: token.symbol,
                        qty: out,
                        buy: buy,
                        current: current,
                        percent: ((current.price - buy.price) / current.price) * 100,
                        diff: (current.price * out) - (buy.price * out)
                    });
                }
            }

            let items = [];

            return result.json().then(data => {
                if (data.errors) {
                    throw 'Error: ' + data.errors.map(x => x.message).join(", ");
                }

                const ethPrice = data.data.bundle.ethPrice;

                data.data.swaps.forEach(swap => {
                    [
                        [swap.amount0Out, swap.pair.token0],
                        [swap.amount1Out, swap.pair.token1]
                    ].forEach(e => {
                        collect(items, e[0], swap.timestamp, e[1], swap.amountUSD, ethPrice);
                    })
                });

                return items;
            });
        };

        const mappings = [
            {
                name: "Date",
                value: e => new Date(e.date * 1000).toLocaleDateString()
            },
            {
                name: "Symbol",
                value: e => e.symbol
            },
            {
                name: "Qty",
                value: e => e.qty
            },
            {
                name: "Buy Price [USD]",
                value: e => formatPrice(e.buy.price)
            },
            {
                name: "Buy Total [USD]",
                value: e => formatTotal(e.buy.total)
            },
            {
                name: "Current Price [USD]",
                value: e => formatPrice(e.current.price)
            },
            {
                name: "Current Total [USD]",
                value: e => formatTotal(e.current.total),
            },
            {
                name: "PnL [USD]",
                value: e => e.diff.toFixed(2) + " (" + e.percent.toFixed(2) + "%)",
                cb: function (e, item) {
                    if (item.diff > 0) {
                        e.classList.add("profit");
                    } else if (item.diff < 0) {
                        e.classList.remove("loss");
                    }
                }
            }
        ];

        let formEl = document.querySelector("#form");
        let addressEl = document.querySelector("#address");

        formEl.onsubmit = async (e) => {
            e.preventDefault();

            try {
                let div = document.querySelector("#data");
                div.classList.add("loading");

                let tbody = document.querySelector("#tdata");
                let thead = document.querySelector("#theader");

                var items = await processAddress(addressEl.value);

                items.sort((a, b) => {
                    return b.date - a.date;
                });

                thead.innerHTML = "";
                let headTr = document.createElement("tr");
                mappings.forEach(mapping => {
                    let el = document.createElement("th");
                    el.innerText = mapping.name;
                    headTr.appendChild(el);
                });

                thead.appendChild(headTr);

                tbody.innerHTML = "";

                items.forEach(item => {
                    let tr = document.createElement('tr');

                    mappings.forEach(mapping => {
                        let el = document.createElement('td');
                        const value = mapping.value(item);
                        el.innerText = value;

                        if (mapping.cb) {
                            mapping.cb(el, item);
                        }

                        tr.appendChild(el);
                    });

                    tbody.appendChild(tr);
                });
            }
            catch (error) {
                if (console) {
                    console.error(error);
                }
                alert('Failed to load: ' + error);
            }
            finally {
                data.classList.remove("loading");
            }
        };
    </script>
</head>

<body>
    <div id="data">
        <form id="form">
            <label for="address">Address</label>
            <input type="text" name="address" value="" id="address" />
            <input type="submit" value="Fetch" />
        </form>
        <p id="progress">Loading..</p>
        <table>
            <thead id="theader"></thead>
            <tbody id="tdata"></tbody>
        </table>
    </div>
</body>

</html>