<!DOCTYPE html>
<html>

<head>
    <style type="text/css">
        table,
        td,
        th {
            border: 1px solid black;
        }

        .loading table {
            visibility: hidden;
        }

        .loading title {
            visibility: visible;
        }

        :not(.loading) #progress {
            visibility: collapse;
            display: none;
        }

        .loading #progress {
            visibility: visible;
            display: inherit;
        }

        form {
            padding: 10px;
        }

        th {
            background-color: cornflowerblue;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }
    </style>
    <script async type="module">
        const processAddress = async (address) => {
            let result = await fetch('https://api.thegraph.com/subgraphs/name/uniswap/uniswap-v2',
                {
                    method: 'POST',
                    body: JSON.stringify({
                        query: `
                        {
                            swaps(where: {
                                to: "${address}"
                            })
                            {
                                id
                                pair {
                                    token0 {
                                        symbol
                                    }
                                    token1 {
                                        symbol
                                    }
                                }
                                amount0In
                                amount0Out
                                amount1In
                                amount1Out
                                amountUSD
                                timestamp
                            }
                        }
                        `
                    })
                });

            const collect = function (items, out, ts, token, usd) {
                if (out) {
                    items.push({
                        date: ts,
                        symbol: token.symbol,
                        qty: out,
                        price: usd / out,
                        total: usd
                    });
                }
            }

            let items = [];

            return result.json().then(data => {
                console.log(data);
                if (data.errors) {
                    throw 'Error: ' + data.errors.map(x => x.message).join(", ");
                }

                data.data.swaps.forEach(swap => {
                    var usd = parseInt(swap.amountUSD);

                    var out0 = parseInt(swap.amount0Out);
                    collect(items, out0, swap.timestamp, swap.pair.token0, usd);

                    var out1 = parseInt(swap.amount1Out);
                    collect(items, out1, swap.timestamp, swap.pair.token1, usd);
                });

                return items;
            });
        };

        const mappings = [
            ["Date", e => new Date(e.date * 1000).toLocaleDateString()],
            ["Symbol", e => e.symbol],
            ["Price", e => e.price.toFixed(10)],
            ["Qty", e => e.qty],
            ["Total", e => e.total]
        ];

        let formEl = document.querySelector("#form");
        let addressEl = document.querySelector("#address");

        formEl.onsubmit = async (e) => {
            e.preventDefault();

            try {
                let div = document.querySelector("#data");
                div.classList.add("loading");

                let tbody = document.querySelector("#tdata");
                let thead = document.querySelector("#theader");

                var items = await processAddress(addressEl.value);

                items.sort((a, b) => {
                    return b.date - a.date;
                });

                thead.innerHTML = "";
                let headTr = document.createElement("tr");
                mappings.forEach(mapping => {
                    let el = document.createElement("th");
                    el.innerText = mapping[0];
                    headTr.appendChild(el);
                });

                thead.appendChild(headTr);

                tbody.innerHTML = "";

                items.forEach(item => {
                    let tr = document.createElement('tr');

                    mappings.forEach(mapping => {
                        let el = document.createElement('td');
                        el.innerText = mapping[1](item);
                        tr.appendChild(el);
                    });

                    tbody.appendChild(tr);
                });
            }
            catch (error) {
                alert('Failed to load: ' + error);
            }
            finally {
                data.classList.remove("loading");
            }
        };
    </script>
</head>

<body>
    <div id="data">
        <form id="form">
            <label for="address">Address</label>
            <input type="text" name="address" value="" id="address" />
            <input type="submit" value="Fetch" />
        </form>
        <p id="progress">Loading..</p>
        <table>
            <thead id="theader"></thead>
            <tbody id="tdata"></tbody>
        </table>
    </div>
</body>

</html>